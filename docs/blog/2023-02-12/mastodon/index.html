<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=1" />

		<title>Automatically posting shared links to Mastodon with Toot</title>

		 
		<meta property="og:title" content="Automatically posting shared links to Mastodon with Toot" />
		
		<meta property="og:type" content="website" />
		
		<meta property="og:author" content="Chris Amico" />
		
		<meta property="og:url" content="https://chrisamico.com" />
		
		<meta property="og:description" content="Journalist &amp; programmer" />
		  
		<link
			rel="stylesheet"
			href="../../../static/normalize.css?t=1679638270.5279887" />
		<link
			rel="stylesheet"
			href="../../../static/site.css?t=1679638270.5279887" />

		<link rel="alternate" href="../../../blog.rss" />
		<link rel="alternate" href="../../../links.rss" />
		    
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=UA-1576645-1"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());
			gtag("config", "UA-1576645-1");
		</script>
		
	</head>
	<body>
		<div class="container">
			
			<header id="about" class="left">
				<div class="fixed">
					<h1>Chris Amico</h1>
					<h2 class="tagline quiet">Journalist &amp; programmer</h2>

					<ul class="social">
						<li class="github">
							<a href="https://github.com/eyeseast" class="icon-github">Github</a>
						</li>
						<li class="linkedin">
							<a href="https://www.linkedin.com/in/chrisamico/" class="icon-linkedin">LinkedIn</a>
						</li>
						<li class="mastodon">
							<a class="icon-mastodon" rel="me" href="https://journa.host/@chrisamico"
								>Mastodon</a
							>
						</li>
						<li>
							<a href="/blog/">Blog archive</a>
						</li>
						<li>
							<a href="/portfolio/">Portfolio</a>
						</li>
					</ul>
				</div>
			</header>

			 
<article id="post" class="right">
	<h1>Automatically posting shared links to Mastodon with Toot</h1>

	<div class="metadata">
		<p><time>Feb 12, 2023</time></p>
	</div>
	<div class="content"><p>I jumped from Twitter to <a href="https://journa.host/@chrisamico">Mastodon</a> in November, shortly after Elon Musk took over and fired half the company&rsquo;s workforce. I&rsquo;ve spent less and less time on Twitter in the last few years, but it was still a good place to watch for interesting discussions and links, and to share my own work. I took the app off my phone and, for the most part, I don&rsquo;t miss it.</p>
<p>Years ago, I set up a feed that piped stories I liked on Instapaper to my Twitter account. I honestly can&rsquo;t remember how I did that, and I&rsquo;m not sure how to turn it off. Twitter&rsquo;s <a href="https://techcrunch.com/2023/02/08/twitter-says-the-basic-tier-of-its-api-will-cost-100-per-month/">new API pricing</a> will probably take care of that for me.</p>
<p>I finally got something similar &ndash; better, even &ndash; set up on Mastodon last night. It&rsquo;s part of this codebase, which means I can tweak it or turn it off or turn it up whenever I want. I&rsquo;m using <a href="https://github.com/ihabunek/toot/">toot</a>, a Python client for Mastodon, on <a href="https://til.simonwillison.net/mastodon/mastodon-bots-github-actions">Simon Willison&rsquo;s recommendation</a>. It&rsquo;s a great library, though it seems mostly intended as a <abbr title="command-line interface">CLI</abbr> tool.</p>
<p>I decided to use it directly from Python, because I wanted to record which links I&rsquo;ve already posted. That part of <code>toot</code> isn&rsquo;t documented, but the code is easy enough to read. We&rsquo;ll see if this comes back to bite me. The whole script is <a href="https://github.com/eyeseast/chrisamico.com/blob/main/links/mastodon.py">here</a>.</p>
<p>The relevant part of the code, which posts to Mastodon and updates a SQLite table, is this function:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">post_link</span><span class="p">(</span><span class="n">link</span><span class="p">):</span>
    <span class="s2">&quot;post the update and record that I did it&quot;</span>
    <span class="n">updates</span> <span class="o">=</span> <span class="n">get_updated_table</span><span class="p">()</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">load_app</span><span class="p">(</span><span class="n">HOST</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">load_user</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">USER</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">link_text</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

    <span class="n">update</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;link_id&quot;</span><span class="p">:</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">post_status</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">update</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;posted&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">],</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
                <span class="s2">&quot;post_url&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">update</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="n">updates</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
</code></pre></div>

<p>It&rsquo;s ultimately a lot more code than Simon is <a href="https://github.com/simonw/covidsewage-bot/blob/main/.github/workflows/toot.yml">using</a> to update his <a href="https://fedi.simonwillison.net/@covidsewage">COVID sewage bot</a>, but I think I have a better understanding of what&rsquo;s possible with the <a href="https://docs.joinmastodon.org/api/">Mastodon API</a> now. It definitely feels like something from the early days of Twitter, when people were inventing new ways to use a new platform, and it was fun.</p>
<p>I might build a bot or two.</p></div>
	<div class="end">
		<p><a href="/blog/">Post archives</a> | <a href="/">Home</a></p>
	</div>
</article>

		</div>

		
	</body>
</html>